trigger: none
pool:
  name: Default

variables:
  terraformDirectory: '.'
  ARM_CLIENT_ID: '87951a98-b733-4ba2-8cb9-d026e17362ed'
  ARM_CLIENT_SECRET: 'AsK8Q~qmPyCvK9n6mp.38qJNUvKPQjAaRDFr0bsp'
  ARM_SUBSCRIPTION_ID: '1674f375-e996-4423-bd25-e0e8f6e76d13'
  ARM_TENANT_ID: 'ec6e8fb5-4284-4351-b9af-a68b18acee8e'

stages:
  - stage: Terraform
    jobs:
      - job: TerraformJob
        displayName: 'Terraform Infrastructure Deployment'
        steps:
          - script: terraform init -upgrade
            displayName: 'Terraform Init'
            workingDirectory: $(terraformDirectory)

          - script: terraform validate
            displayName: 'Terraform Validate'
            workingDirectory: $(terraformDirectory)

          - script: |
              terraform taint null_resource.install_ingress_aks2 || true
              terraform plan -lock=false -out=tfplan
            displayName: 'Terraform Plan'
            workingDirectory: $(terraformDirectory)

          - script: terraform apply -auto-approve -lock=false tfplan
            displayName: 'Terraform Apply'
            continueOnError: true
            workingDirectory: $(terraformDirectory)
