trigger: none  # Manual trigger only

pool:
  name: Default

variables:
  terraformDirectory: '.'         # Adjust if your main.tf is in a subfolder
  azureServiceConnection: 'ARM'   # Service connection name in Azure DevOps
  terraformVersion: '1.7.5'       # Adjust as needed

stages:
  - stage: Terraform
    displayName: 'Terraform Deployment Stage'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform Commands'
        steps:

          # Step 1: Install Terraform (if not on agent)
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          # Step 2: Terraform Init
          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform init -upgrade -input=false

          # Step 3: Terraform Validate
          - task: AzureCLI@2
            displayName: 'Terraform Validate'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform validate

          # Step 4: Terraform Plan
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform plan -lock=false -out=tfplan

          # Optional: Publish tfplan as an artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Plan Artifact'
            inputs:
              PathtoPublish: '$(terraformDirectory)/tfplan'
              ArtifactName: 'tfplan'
              publishLocation: 'Container'

          # Step 5: Terraform Apply
          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform apply -auto-approve -lock=false tfplan
