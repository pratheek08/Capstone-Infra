trigger: none

pool:
  name: Default

variables:
  terraformDirectory: '.'         
  azureServiceConnection: 'ARM'   

stages:
  - stage: Terraform
    displayName: 'Terraform Deployment Stage'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform Commands'
        steps:
          # Step 1: Verify Terraform version (optional)
          - script: terraform version
            displayName: 'Check Terraform Version'

          # Step 2: Terraform Init
          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform init -upgrade -input=false

          # Step 3: Terraform Validate
          - task: AzureCLI@2
            displayName: 'Terraform Validate'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform validate

          # Step 4: Terraform Plan
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform plan -out=tfplan

          # Step 5: Publish Plan Artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Plan Artifact'
            inputs:
              PathtoPublish: '$(terraformDirectory)/tfplan'
              ArtifactName: 'tfplan'
              publishLocation: 'Container'

          # Step 6: Terraform Apply
          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(terraformDirectory)
              inlineScript: |
                terraform apply -auto-approve tfplan
